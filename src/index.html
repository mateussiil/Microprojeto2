<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <title>WebSockets na disciplina de sistemas distribuídos</title>
</head>

<body>
    <div style="display: flex;flex-direction: row;">
        <div style="display: flex;flex-direction: column;">
            <div id="cardapio">
            </div>
            <div style="margin-top: 30px;">
                Opa, tem uma sugestao pro cardápio? insira aqui:
                <input id="fazerSugestao" type="text">
                <input id="botao" type="button" onclick="fazerSugestao()" value="ok">
            </div>
            <div style="margin-top: 30px;">
                Pedido:
                <input id="fazerPedido" type="text">
                <input id="botao" type="button" onclick="fazerPedido()" value="Ok">
                <div id="texto"></div>
            </div>
        </div>
        <div style="margin-left: 30px;">
            <ul id="carrinho"></ul>
            <div id="valorTotal"></div>
        </div>
        <div>
        </div>
</body>
<script>
    var HOST = location.origin.replace(/^http/, 'ws');
    const socket = new WebSocket(HOST);

    const create_UUID = () => {
        var dt = new Date().getTime();
        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = (dt + Math.random() * 16) % 16 | 0;
            dt = Math.floor(dt / 16);
            return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
        return uuid;
    }

    const name = prompt('Bem vindo a Delisciousocket, deseja se identificar? Caso não queira, deixe vazio')
    const id = create_UUID()

    socket.onopen = () => {
        enviarMensagem({ id: id, name: name ? name : " " }, 'newUser')
    }

    socket.onmessage = (message_stringfy) => {
        var message_parse = JSON.parse(message_stringfy.data)
        var type = message_parse.type
        var message = message_parse.message

        if (type === "cardapio") {
            var minhaDiv = document.querySelector("#cardapio");

            var textNode = document.createElement("div")
            textNode.innerHTML = `${message}`;
            minhaDiv.appendChild(textNode);
        }

        if (type === "info") {
            var minhaDiv = document.querySelector("#texto");

            var textNode = document.createElement("div")
            textNode.innerHTML = `${message}`;
            minhaDiv.appendChild(textNode);
        }

        if (type === "valorTotal") {
            var minhaDiv = document.querySelector("#valorTotal");
            minhaDiv.innerHTML = `${message}`;
        }

        if (type === "diminuir") {
            var element = document.getElementById(`li-carrinho-item-${message.index}`)

            if (element) {
                element.innerHTML = `nome: ${message.name} quantidade:${message.quantity} valor:${message.value * message.quantity}`;
            }

            var text = element.innerHTML

            var quantidade = (text.slice(text.indexOf("quantidade"), text.indexOf("valor")))
            quantidade = quantidade.slice(quantidade.indexOf(":") + 1, quantidade.length - 1)

            if (quantidade === "0") {
                element.parentNode.parentNode.removeChild(element.parentNode)
            }
        }

        if (type === "carrinho") {
            var minhaDiv = document.querySelector("#carrinho");

            var element = document.getElementById(`li-carrinho-item-${message.index}`)

            if (element) {
                element.innerHTML = `nome: ${message.name} quantidade:${message.quantity} valor:${message.value * message.quantity}`;
            }

            if (!element) {
                var divNode = document.createElement("div")
                var liNode = document.createElement("li")
                var buttonTrashNode = document.createElement("button")
                var minusTrashNode = document.createElement("button")

                buttonTrashNode.setAttribute("class", "fa fa-trash")
                buttonTrashNode.setAttribute("id", `li-trash-item-${message.index}`)
                buttonTrashNode.onclick = function () {
                    enviarMensagem({ message_: message.index, user: id }, 'excluir')

                    minhaDiv.removeChild(buttonTrashNode.parentNode)
                }

                minusTrashNode.setAttribute("class", "fa fa-minus")
                minusTrashNode.setAttribute("id", `li-minus-item-${message.index}`)

                minusTrashNode.onclick = function () {
                    enviarMensagem({ message_: message.index, user: id }, 'diminuir')
                }

                liNode.setAttribute("class", "li-carrinho")
                liNode.setAttribute("id", `li-carrinho-item-${message.index}`)
                liNode.innerHTML = `nome: ${message.name} quantidade:${message.quantity} valor:${message.value * message.quantity}`;

                divNode.appendChild(liNode)
                divNode.appendChild(minusTrashNode)
                divNode.appendChild(buttonTrashNode)

                minhaDiv.appendChild(divNode);
            }
        }
    }

    const enviarMensagem = (message, type) => {
        socket.send(JSON.stringify({ message: message, type: type }));
    }

    const fazerSugestao = () => {
        var caixaDeTexto = document.querySelector("#fazerSugestao");
        enviarMensagem({message_: caixaDeTexto.value, user:id}, 'sugestao')
    }

    const fazerPedido = () => {
        var caixaDeTexto = document.querySelector("#fazerPedido");
        enviarMensagem({message_: caixaDeTexto.value, user:id}, 'escolher')
    }

</script>

</html>